# @ModernMediaScanner.java æˆ‘å‘ç°åœ¨æ‰«æåˆ°ééŸ³è§†é¢‘æ–‡ä»¶ä¸ä¼šnew MediaMetadataRetriever ,è€Œä¸”ä¹Ÿä¸æ˜¯æ‰€æœ‰çš„éŸ³è§†é¢‘æ–‡ä»¶ä¼šnew MediaMetadataRetrieverä»€ä¹ˆæ—¶å€™ä¼šnew MediaMetadataRetriever
## MediaMetadataRetriever çš„åˆ›å»ºæ—¶æœº

### 1. **æ ¹æ®åª’ä½“ç±»å‹åˆ¤æ–­**

`MediaMetadataRetriever` åªåœ¨ä»¥ä¸‹åª’ä½“ç±»å‹çš„æ–‡ä»¶æ‰«ææ—¶åˆ›å»ºï¼š

```1319:1360:CarMediaCenter/MediaProvider/src/com/android/providers/media/scan/ModernMediaScanner.java
private static @NonNull ContentProviderOperation.Builder scanItemAudio(long existingId,
        File file, BasicFileAttributes attrs, String mimeType, int mediaType,
        String volumeName) {
    // ...çœç•¥å…¶ä»–ä»£ç ...
    try (FileInputStream is = new FileInputStream(file)) {
        try (MediaMetadataRetriever mmr = new MediaMetadataRetriever()) {
            mmr.setDataSource(is.getFD());
            withRetrieverValues(op, mmr, mimeType);
            // ...
        }
    } catch (Exception e) {
        logTroubleScanning(file, e);
    }
    return op;
}
```

```1394:1441:CarMediaCenter/MediaProvider/src/com/android/providers/media/scan/ModernMediaScanner.java
private static @NonNull ContentProviderOperation.Builder scanItemVideo(long existingId,
        File file, BasicFileAttributes attrs, String mimeType, int mediaType,
        String volumeName) {
    // ...çœç•¥å…¶ä»–ä»£ç ...
    try (FileInputStream is = new FileInputStream(file)) {
        try (MediaMetadataRetriever mmr = new MediaMetadataRetriever()) {
            mmr.setDataSource(is.getFD());
            withRetrieverValues(op, mmr, mimeType);
            // ...
        }
    } catch (Exception e) {
        logTroubleScanning(file, e);
    }
    return op;
}
```

### 2. **scanItem æ–¹æ³•çš„è·¯ç”±é€»è¾‘**

```1082:1098:CarMediaCenter/MediaProvider/src/com/android/providers/media/scan/ModernMediaScanner.java
switch (mediaType) {
    case FileColumns.MEDIA_TYPE_AUDIO:
        return scanItemAudio(existingId, file, attrs, mimeType, mediaType, volumeName);
    case FileColumns.MEDIA_TYPE_VIDEO:
        return scanItemVideo(existingId, file, attrs, mimeType, mediaType, volumeName);
    case FileColumns.MEDIA_TYPE_IMAGE:
        return scanItemImage(existingId, file, attrs, mimeType, mediaType, volumeName);
    case FileColumns.MEDIA_TYPE_PLAYLIST:
        return scanItemPlaylist(existingId, file, attrs, mimeType, mediaType, volumeName);
    case FileColumns.MEDIA_TYPE_SUBTITLE:
        return scanItemSubtitle(existingId, file, attrs, mimeType, mediaType, volumeName);
    case FileColumns.MEDIA_TYPE_DOCUMENT:
        return scanItemDocument(existingId, file, attrs, mimeType, mediaType, volumeName);
    default:
        return scanItemFile(existingId, file, attrs, mimeType, mediaType, volumeName);
}
```

### 3. **ä»€ä¹ˆæ—¶å€™ä¸ä¼šåˆ›å»º MediaMetadataRetriever**

ä»¥ä¸‹æ–‡ä»¶ç±»å‹ä¸ä¼šåˆ›å»º `MediaMetadataRetriever`ï¼š

- **å›¾ç‰‡æ–‡ä»¶** (`MEDIA_TYPE_IMAGE`) - ä½¿ç”¨ `ExifInterface` ä»£æ›¿
- **æ’­æ”¾åˆ—è¡¨** (`MEDIA_TYPE_PLAYLIST`) 
- **å­—å¹•æ–‡ä»¶** (`MEDIA_TYPE_SUBTITLE`)
- **æ–‡æ¡£æ–‡ä»¶** (`MEDIA_TYPE_DOCUMENT`)
- **å…¶ä»–ç±»å‹æ–‡ä»¶** (`default` åˆ†æ”¯)
- **ç›®å½•** (ä½¿ç”¨ `scanItemDirectory`)

### 4. **å³ä½¿æ˜¯éŸ³è§†é¢‘æ–‡ä»¶ä¹Ÿä¸ä¸€å®šåˆ›å»ºçš„æƒ…å†µ**

åœ¨ `visitFile` æ–¹æ³•ä¸­ï¼Œå³ä½¿æ–‡ä»¶æ˜¯éŸ³è§†é¢‘ç±»å‹ï¼Œå¦‚æœæ»¡è¶³ä»¥ä¸‹æ¡ä»¶ä¹Ÿä¼šè·³è¿‡æ‰«æï¼ˆä¸åˆ›å»º `MediaMetadataRetriever`ï¼‰ï¼š

```802:817:CarMediaCenter/MediaProvider/src/com/android/providers/media/scan/ModernMediaScanner.java
final boolean sameMetadata =
        hasSameMetadata(attrs, realFile, isPendingFromFuse, c);
final boolean sameMediaType = actualMediaType == mediaType;
if (sameMetadata && sameMediaType) {
    if (LOGV) Log.v(TAG, "Skipping unchanged " + file);
    return FileVisitResult.CONTINUE;
}

// ç‰¹æ®Šæƒ…å†µï¼švideo/mp4 å’Œ audio/mp4 ä¹‹é—´çš„è½¬æ¢
if (sameMetadata
        && "video/mp4".equalsIgnoreCase(actualMimeType)
        && "audio/mp4".equalsIgnoreCase(mimeType)) {
    if (LOGV) Log.v(TAG, "Skipping unchanged video/audio " + file);
    return FileVisitResult.CONTINUE;
}
```

### 5. **æ€»ç»“**

**ä¼šåˆ›å»º MediaMetadataRetriever çš„æƒ…å†µï¼š**
- æ–‡ä»¶ç±»å‹ä¸º `MEDIA_TYPE_AUDIO` æˆ– `MEDIA_TYPE_VIDEO`
- ä¸”æ–‡ä»¶å†…å®¹å‘ç”Ÿäº†å˜åŒ–ï¼ˆæ—¶é—´æˆ³ã€å¤§å°ç­‰ä¸åŒï¼‰
- ä¸”æ‰«æè¿‡ç¨‹ä¸­æ²¡æœ‰å¼‚å¸¸

**ä¸ä¼šåˆ›å»º MediaMetadataRetriever çš„æƒ…å†µï¼š**
- ééŸ³è§†é¢‘æ–‡ä»¶ï¼ˆå›¾ç‰‡ã€æ–‡æ¡£ã€å­—å¹•ç­‰ï¼‰
- æ–‡ä»¶å†…å®¹æœªå‘ç”Ÿå˜åŒ–çš„éŸ³è§†é¢‘æ–‡ä»¶
- ç›®å½•
- æ‰«æè¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸çš„æ–‡ä»¶

è¿™æ ·è®¾è®¡çš„åŸå› æ˜¯ `MediaMetadataRetriever` ä¸»è¦ç”¨äºæå–éŸ³è§†é¢‘æ–‡ä»¶çš„å…ƒæ•°æ®ï¼ˆå¦‚æ—¶é•¿ã€æ¯”ç‰¹ç‡ã€è‰ºæœ¯å®¶ç­‰ï¼‰ï¼Œå¯¹äºå…¶ä»–ç±»å‹çš„æ–‡ä»¶ä½¿ç”¨ç›¸åº”çš„ä¸“é—¨å·¥å…·ï¼ˆå¦‚å›¾ç‰‡ç”¨ `ExifInterface`ï¼‰æ›´åŠ é«˜æ•ˆå’Œå‡†ç¡®ã€‚


Ran tool

Ran tool
Ran tool

Ran tool
Ran tool
# walkFileTreeè¿™ä¸ªæ–¹æ³•çš„flowä¼šè§¦å‘visitFileå—
æ˜¯çš„ï¼Œ`walkFileTree()` æ–¹æ³•çš„æµç¨‹**ä¼šè§¦å‘ `visitFile` æ–¹æ³•**ã€‚

è®©æˆ‘è§£é‡Šä¸€ä¸‹å…·ä½“çš„æµç¨‹ï¼š

## 1. **Scan ç±»å®ç°äº† FileVisitor æ¥å£**
```java
// ç¬¬328è¡Œ
private class Scan implements Runnable, FileVisitor<Path>, AutoCloseable {
```

## 2. **walkFileTree è°ƒç”¨ä¼šè‡ªåŠ¨è§¦å‘ visitFile**
åœ¨ `walkFileTree()` æ–¹æ³•ä¸­ï¼š
```java
// ç¬¬468-470è¡Œ
if (mFilesUri.equals(MediaStore.Files.EXTERNAL_CONTENT_URI)) {
    Files.walkFileTree(mRoot.toPath(), EnumSet.noneOf(FileVisitOption.class), mMaxScanDepth, this);
} else {
    Files.walkFileTree(mRoot.toPath(), this);
}
```

è¿™é‡Œä¼ å…¥çš„ `this` å°±æ˜¯å½“å‰ `Scan` å®ä¾‹ï¼Œ`Files.walkFileTree()` ä¼šåœ¨éå†æ–‡ä»¶æ ‘æ—¶è‡ªåŠ¨è°ƒç”¨ `FileVisitor` æ¥å£çš„ç›¸åº”æ–¹æ³•ã€‚

## 3. **visitFile æ–¹æ³•çš„è§¦å‘æ—¶æœº**

**a) å¯¹æ¯ä¸ªæ–‡ä»¶è‡ªåŠ¨è°ƒç”¨ï¼š**
```java
// ç¬¬731è¡Œ
@Override
public FileVisitResult visitFile(Path file, BasicFileAttributes attrs) throws IOException {
    if (LOGV) Log.v(TAG, "Visiting " + file);
    mFileCount++;
    // ... å…·ä½“çš„æ–‡ä»¶æ‰«æé€»è¾‘
}
```

**b) å¯¹ç›®å½•ä¹Ÿä¼šè°ƒç”¨ï¼š**
```java
// ç¬¬725-727è¡Œï¼Œåœ¨ preVisitDirectory ä¸­
// Scan this directory as a normal file so that "parent" database
// entries are created
return visitFile(dir, attrs);
```

## 4. **å®Œæ•´çš„è°ƒç”¨é“¾**
```
walkFileTree() 
  â†“
Files.walkFileTree() (Java NIO API)
  â†“
è‡ªåŠ¨è°ƒç”¨ FileVisitor æ¥å£æ–¹æ³•ï¼š
  â”œâ”€ preVisitDirectory() â†’ è°ƒç”¨ visitFile(dir, attrs)
  â”œâ”€ visitFile() â†’ å¤„ç†æ¯ä¸ªæ–‡ä»¶
  â”œâ”€ postVisitDirectory()
  â””â”€ visitFileFailed() (å¦‚æœæœ‰å¼‚å¸¸)
```

æ‰€ä»¥ï¼Œ**`walkFileTree()` æ–¹æ³•é€šè¿‡ Java NIO çš„æ–‡ä»¶éå†æœºåˆ¶ï¼Œä¼šå¯¹ç›®å½•æ ‘ä¸­çš„æ¯ä¸ªæ–‡ä»¶å’Œç›®å½•éƒ½è§¦å‘ `visitFile` æ–¹æ³•è°ƒç”¨**ã€‚


# MediaProviderä¸­éƒ½æä¾›äº†å“ªäº›åŠŸèƒ½ æ¯”å¦‚ æ–‡ä»¶æ‰«æè¿™ç§ï¼Œæ˜¯å“ªäº›æ–‡ä»¶ç»„æˆäº†ä¸€ä¸ªåŠŸèƒ½
```mermaid
graph TB
    subgraph "MediaProvider Core Architecture"
        A["MediaProvider.java<br/>(Main ContentProvider)"] 
        B["MediaService.java<br/>(Background Service)"]
        C["DatabaseHelper.java<br/>(Database Management)"]
        D["MediaApplication.java<br/>(Application Entry Point)"]
    end
    
    subgraph "File Scanning System"
        E["scan/MediaScanner.java<br/>(Scanner Interface)"]
        F["scan/ModernMediaScanner.java<br/>(Current Implementation)"]
        G["scan/LegacyMediaScanner.java<br/>(Legacy Support)"]
        H["scan/NullMediaScanner.java<br/>(No-op Implementation)"]
    end
    
    subgraph "FUSE File System"
        I["fuse/ExternalStorageServiceImpl.java<br/>(Storage Service)"]
        J["fuse/FuseDaemon.java<br/>(FUSE Interface)"]
        K["jni/FuseDaemon.cpp<br/>(Native FUSE Implementation)"]
        L["jni/MediaProviderWrapper.cpp<br/>(JNI Bridge)"]
    end
    
    subgraph "Document Provider"
        M["MediaDocumentsProvider.java<br/>(Documents API)"]
    end
    
    subgraph "Transcoding System"
        N["TranscodeHelper.java<br/>(Interface)"]
        O["TranscodeHelperImpl.java<br/>(Implementation)"]
        P["TranscodeHelperNoOp.java<br/>(No-op)"]
    end
    
    subgraph "Playlist Management"
        Q["playlist/Playlist.java<br/>(Core Playlist)"]
        R["playlist/M3uPlaylistPersister.java<br/>(M3U Format)"]
        S["playlist/PlsPlaylistPersister.java<br/>(PLS Format)"]
        T["playlist/WplPlaylistPersister.java<br/>(WPL Format)"]
        U["playlist/XspfPlaylistPersister.java<br/>(XSPF Format)"]
    end
    
    subgraph "User Interface"
        V["PermissionActivity.java<br/>(Permission Dialogs)"]
        W["CacheClearingActivity.java<br/>(Cache Management)"]
        X["photopicker/PhotoPickerActivity.java<br/>(Photo Picker UI)"]
    end
    
    subgraph "Metrics & Monitoring"
        Y["metrics/PulledMetrics.java<br/>(System Metrics)"]
        Z["metrics/StorageAccessMetrics.java<br/>(Access Tracking)"]
        AA["metrics/TranscodeMetrics.java<br/>(Transcode Stats)"]
    end
    
    subgraph "Utility Libraries"
        BB["util/FileUtils.java<br/>(File Operations)"]
        CC["util/DatabaseUtils.java<br/>(DB Utilities)"]
        DD["util/MimeUtils.java<br/>(MIME Type Detection)"]
        EE["util/ExifUtils.java<br/>(EXIF Processing)"]
        FF["util/XmpInterface.java<br/>(XMP Metadata)"]
        GG["util/IsoInterface.java<br/>(ISO Metadata)"]
    end

    A --> B
    A --> C
    A --> E
    A --> M
    A --> N
    B --> E
    E --> F
    E --> G
    E --> H
    A --> I
    I --> J
    J --> K
    K --> L
    Q --> R
    Q --> S
    Q --> T
    Q --> U
```
# MediaProvider åŠŸèƒ½å®Œæ•´åˆ†æ

## **æ ¸å¿ƒåŠŸèƒ½æ¨¡å—åŠæ–‡ä»¶ç»„æˆ**

### **1. ğŸ“ å†…å®¹æä¾›è€…æ ¸å¿ƒ (Content Provider Core)**
**ä¸»è¦åŠŸèƒ½ï¼š** ä½œä¸ºAndroidç³»ç»Ÿçš„åª’ä½“æ•°æ®è®¿é—®å…¥å£

| æ–‡ä»¶ | åŠŸèƒ½æè¿° |
|------|----------|
| `MediaProvider.java` | ä¸»è¦çš„ContentProviderå®ç°ï¼Œå¤„ç†æ‰€æœ‰åª’ä½“æŸ¥è¯¢ã€æ’å…¥ã€æ›´æ–°ã€åˆ é™¤æ“ä½œ |
| `DatabaseHelper.java` | æ•°æ®åº“æ¶æ„ç®¡ç†ï¼Œå¤„ç†æ•°æ®åº“åˆ›å»ºã€å‡çº§ã€è¿ç§» |
| `MediaApplication.java` | åº”ç”¨ç¨‹åºå…¥å£ç‚¹ï¼Œè´Ÿè´£ç»„ä»¶åˆå§‹åŒ– |
| `LocalCallingIdentity.java` | æƒé™ç®¡ç†å’Œè°ƒç”¨è€…èº«ä»½éªŒè¯ |
| `MediaVolume.java` | å­˜å‚¨å·ç®¡ç† |
| `VolumeCache.java` | å·ä¿¡æ¯ç¼“å­˜ |

### **2. ğŸ” æ–‡ä»¶æ‰«æç³»ç»Ÿ (File Scanning System)**
**ä¸»è¦åŠŸèƒ½ï¼š** è‡ªåŠ¨å‘ç°å’Œç´¢å¼•åª’ä½“æ–‡ä»¶ï¼Œæå–å…ƒæ•°æ®

| æ–‡ä»¶ | åŠŸèƒ½æè¿° |
|------|----------|
| `scan/MediaScanner.java` | æ‰«æå™¨æ¥å£å®šä¹‰ |
| `scan/ModernMediaScanner.java` | **å½“å‰ä¸»è¦å®ç°**ï¼Œä½¿ç”¨MediaMetadataRetrieveræå–å…ƒæ•°æ® |
| `scan/LegacyMediaScanner.java` | æ—§ç‰ˆæ‰«æå™¨æ”¯æŒ |
| `scan/NullMediaScanner.java` | ç©ºæ“ä½œæ‰«æå™¨ |
| `MediaService.java` | åå°æœåŠ¡ï¼Œåè°ƒæ‰«æä»»åŠ¡ |
| `IdleService.java` | ç©ºé—²æ—¶é—´æ‰«ææœåŠ¡ |
| `MediaReceiver.java` | å¹¿æ’­æ¥æ”¶å™¨ï¼Œå“åº”ç³»ç»Ÿäº‹ä»¶è§¦å‘æ‰«æ |

### **3. ğŸ’¾ FUSEæ–‡ä»¶ç³»ç»Ÿ (FUSE File System)**
**ä¸»è¦åŠŸèƒ½ï¼š** æä¾›ç”¨æˆ·ç©ºé—´æ–‡ä»¶ç³»ç»Ÿï¼Œæ”¯æŒåª’ä½“æ–‡ä»¶çš„é€æ˜è®¿é—®å’Œè½¬ç 

| æ–‡ä»¶ | åŠŸèƒ½æè¿° |
|------|----------|
| `fuse/ExternalStorageServiceImpl.java` | å¤–éƒ¨å­˜å‚¨æœåŠ¡å®ç° |
| `fuse/FuseDaemon.java` | Javaå±‚FUSEå®ˆæŠ¤è¿›ç¨‹ |
| `jni/FuseDaemon.cpp` | **Nativeå±‚FUSEå®ç°** |
| `jni/FuseUtils.cpp` | FUSEå·¥å…·å‡½æ•° |
| `jni/MediaProviderWrapper.cpp` | JNIæ¡¥æ¥å±‚ |
| `jni/node.cpp` | FUSEèŠ‚ç‚¹å®ç° |
| `jni/ReaddirHelper.cpp` | ç›®å½•è¯»å–åŠ©æ‰‹ |
| `jni/RedactionInfo.cpp` | æ•°æ®è„±æ•å¤„ç† |

### **4. ğŸµ æ’­æ”¾åˆ—è¡¨ç®¡ç† (Playlist Management)**
**ä¸»è¦åŠŸèƒ½ï¼š** æ”¯æŒå¤šç§æ’­æ”¾åˆ—è¡¨æ ¼å¼çš„è§£æå’Œç”Ÿæˆ

| æ–‡ä»¶ | åŠŸèƒ½æè¿° |
|------|----------|
| `playlist/Playlist.java` | æ’­æ”¾åˆ—è¡¨æ ¸å¿ƒæŠ½è±¡ |
| `playlist/M3uPlaylistPersister.java` | M3Uæ ¼å¼æ”¯æŒ |
| `playlist/PlsPlaylistPersister.java` | PLSæ ¼å¼æ”¯æŒ |
| `playlist/WplPlaylistPersister.java` | WPLæ ¼å¼æ”¯æŒ |
| `playlist/XspfPlaylistPersister.java` | XSPFæ ¼å¼æ”¯æŒ |
| `playlist/PlaylistPersister.java` | æŒä¹…åŒ–æ¥å£ |

### **5. ğŸ”„ åª’ä½“è½¬ç ç³»ç»Ÿ (Transcoding System)**
**ä¸»è¦åŠŸèƒ½ï¼š** å®æ—¶åª’ä½“æ ¼å¼è½¬æ¢ï¼Œæ”¯æŒä¸åŒåº”ç”¨çš„å…¼å®¹æ€§éœ€æ±‚

| æ–‡ä»¶ | åŠŸèƒ½æè¿° |
|------|----------|
| `TranscodeHelper.java` | è½¬ç æ¥å£å®šä¹‰ |
| `TranscodeHelperImpl.java` | **å®é™…è½¬ç å®ç°** |
| `TranscodeHelperNoOp.java` | ç©ºæ“ä½œå®ç° |

### **6. ğŸ“„ æ–‡æ¡£æä¾›è€… (Document Provider)**
**ä¸»è¦åŠŸèƒ½ï¼š** é€šè¿‡Documents APIæä¾›æ–‡ä»¶è®¿é—®

| æ–‡ä»¶ | åŠŸèƒ½æè¿° |
|------|----------|
| `MediaDocumentsProvider.java` | **DocumentsProviderå®ç°**ï¼Œé›†æˆåˆ°ç³»ç»Ÿæ–‡ä»¶ç®¡ç†å™¨ |

### **7. ğŸ–¼ï¸ ç”¨æˆ·ç•Œé¢ç»„ä»¶ (User Interface)**
**ä¸»è¦åŠŸèƒ½ï¼š** æƒé™ç®¡ç†ã€ç¼“å­˜æ¸…ç†ã€ç…§ç‰‡é€‰æ‹©å™¨

| æ–‡ä»¶ | åŠŸèƒ½æè¿° |
|------|----------|
| `PermissionActivity.java` | æƒé™è¯·æ±‚å¯¹è¯æ¡† |
| `CacheClearingActivity.java` | ç¼“å­˜æ¸…ç†ç•Œé¢ |
| `photopicker/PhotoPickerActivity.java` | **ç…§ç‰‡é€‰æ‹©å™¨UI** |

### **8. ğŸ“Š æŒ‡æ ‡å’Œç›‘æ§ (Metrics & Monitoring)**
**ä¸»è¦åŠŸèƒ½ï¼š** æ€§èƒ½ç›‘æ§ã€ä½¿ç”¨ç»Ÿè®¡ã€ç³»ç»ŸæŒ‡æ ‡æ”¶é›†

| æ–‡ä»¶ | åŠŸèƒ½æè¿° |
|------|----------|
| `metrics/PulledMetrics.java` | ç³»ç»Ÿæ‹‰å–æŒ‡æ ‡ |
| `metrics/StorageAccessMetrics.java` | å­˜å‚¨è®¿é—®ç»Ÿè®¡ |
| `metrics/TranscodeMetrics.java` | è½¬ç æ€§èƒ½æŒ‡æ ‡ |

### **9. ğŸ› ï¸ å·¥å…·åº“ (Utility Libraries)**
**ä¸»è¦åŠŸèƒ½ï¼š** é€šç”¨å·¥å…·å‡½æ•°å’Œè¾…åŠ©ç±»

| åˆ†ç±» | æ–‡ä»¶ | åŠŸèƒ½æè¿° |
|------|------|----------|
| **æ–‡ä»¶æ“ä½œ** | `util/FileUtils.java` | æ–‡ä»¶è·¯å¾„å¤„ç†ã€æƒé™æ£€æŸ¥ |
| **æ•°æ®åº“** | `util/DatabaseUtils.java` | æ•°æ®åº“æŸ¥è¯¢æ„å»ºã€ä¼˜åŒ– |
| **MIMEç±»å‹** | `util/MimeUtils.java` | MIMEç±»å‹æ£€æµ‹å’Œæ˜ å°„ |
| **å…ƒæ•°æ®** | `util/ExifUtils.java` | EXIFæ•°æ®å¤„ç† |
| | `util/XmpInterface.java` | XMPå…ƒæ•°æ®å¤„ç† |
| | `util/IsoInterface.java` | ISOå…ƒæ•°æ®å¤„ç† |
| **çº¿ç¨‹ç®¡ç†** | `util/BackgroundThread.java` | åå°çº¿ç¨‹æ±  |
| | `util/ForegroundThread.java` | å‰å°çº¿ç¨‹ç®¡ç† |
| **å…¶ä»–** | `util/Logging.java` | æ—¥å¿—å·¥å…· |
| | `util/Memory.java` | å†…å­˜ç®¡ç† |
| | `util/PermissionUtils.java` | æƒé™å·¥å…· |

## **å…³é”®åŠŸèƒ½æµç¨‹**

### **æ–‡ä»¶æ‰«ææµç¨‹ (ä»¥MP4ä¸ºä¾‹)**
1. **è§¦å‘æ‰«æ** â†’ `MediaReceiver` æ¥æ”¶ç³»ç»Ÿå¹¿æ’­
2. **ä»»åŠ¡è°ƒåº¦** â†’ `MediaService` åˆ›å»ºæ‰«æä»»åŠ¡
3. **æ–‡ä»¶å‘ç°** â†’ `ModernMediaScanner` éå†ç›®å½•
4. **å…ƒæ•°æ®æå–** â†’ ä½¿ç”¨ `MediaMetadataRetriever`
5. **æ•°æ®åº“æ›´æ–°** â†’ `DatabaseHelper` å­˜å‚¨å…ƒæ•°æ®
6. **é€šçŸ¥ç³»ç»Ÿ** â†’ é€šè¿‡ `ContentResolver` é€šçŸ¥å˜æ›´

### **FUSEæ–‡ä»¶ç³»ç»Ÿè®¿é—®æµç¨‹**
1. **åº”ç”¨è¯·æ±‚** â†’ åº”ç”¨è®¿é—®åª’ä½“æ–‡ä»¶
2. **FUSEæ‹¦æˆª** â†’ `FuseDaemon.cpp` æ‹¦æˆªæ–‡ä»¶ç³»ç»Ÿè°ƒç”¨
3. **æƒé™æ£€æŸ¥** â†’ é€šè¿‡JNIè°ƒç”¨Javaå±‚æƒé™éªŒè¯
4. **æ–‡ä»¶å¤„ç†** â†’ å¯èƒ½è§¦å‘å®æ—¶è½¬ç 
5. **è¿”å›æ•°æ®** â†’ å‘åº”ç”¨è¿”å›æ–‡ä»¶å†…å®¹

è¿™ä¸ªæ¶æ„ç¡®ä¿äº†MediaProviderèƒ½å¤Ÿï¼š
- **é«˜æ•ˆæ‰«æ**å¤§é‡åª’ä½“æ–‡ä»¶
- **å®‰å…¨æ§åˆ¶**åº”ç”¨å¯¹åª’ä½“çš„è®¿é—®
- **é€æ˜è½¬ç **ä¸å…¼å®¹çš„åª’ä½“æ ¼å¼
- **ç»Ÿä¸€æ¥å£**ä¸ºæ‰€æœ‰åª’ä½“ç›¸å…³æ“ä½œæä¾›ä¸€è‡´çš„API


# åœæ­¢scan

æ ¹æ®å¯¹ä»£ç çš„åˆ†æï¼ŒMediaProviderä¸­**æ²¡æœ‰ä¸€ä¸ªç›´æ¥å¯¹åº”çš„"åœæ­¢æ‰«æ"å‡½æ•°**ï¼Œä½†æœ‰ä»¥ä¸‹å‡ ç§åœæ­¢æœºåˆ¶ï¼š

## **åœæ­¢æ‰«æçš„æ–¹å¼**

### **1. ğŸ›‘ å·åˆ†ç¦»æ—¶è‡ªåŠ¨åœæ­¢ - `onDetachVolume()`**

```280:290:CarMediaCenter/MediaProvider/src/com/android/providers/media/scan/ModernMediaScanner.java
@Override
public void onDetachVolume(MediaVolume volume) {
    Log.i(TAG, "onDetachVolume volumeName=" + volume);
    synchronized (mActiveScans) {
        for (Scan scan : mActiveScans) {
            Log.i(TAG, "       scan volumeName=" + volume);
            if (volume.equals(scan.mVolume)) {
                Log.i(TAG, "        match successful " + volume);
                scan.mSignal.cancel();
            }
        }
    }
}
```

**è§¦å‘åœºæ™¯**: å½“å­˜å‚¨å·è¢«å¸è½½/ç§»é™¤æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è°ƒç”¨æ­¤æ–¹æ³•åœæ­¢è¯¥å·çš„æ‰€æœ‰æ‰«æã€‚

### **2. ğŸ”„ ç©ºé—²æ‰«æåœæ­¢ - `onIdleScanStopped()`**

```293:301:CarMediaCenter/MediaProvider/src/com/android/providers/media/scan/ModernMediaScanner.java
@Override
public void onIdleScanStopped() {
    synchronized (mActiveScans) {
        for (Scan scan : mActiveScans) {
            if (scan.mReason == REASON_IDLE) {
                scan.mSignal.cancel();
            }
        }
    }
}
```

**è§¦å‘åœºæ™¯**: å½“ç³»ç»Ÿä¸å†ç©ºé—²æ—¶ï¼Œåœæ­¢æ‰€æœ‰ç©ºé—²æ—¶è¿›è¡Œçš„æ‰«æä»»åŠ¡ã€‚

### **3. â¹ï¸ JobIntentService ç”Ÿå‘½å‘¨æœŸåœæ­¢**

`MediaService` ç»§æ‰¿è‡ª `JobIntentService`ï¼Œå½“æœåŠ¡è¢«ç³»ç»Ÿç»ˆæ­¢æ—¶ï¼š

- **ç³»ç»Ÿèµ„æºä¸è¶³** â†’ è‡ªåŠ¨åœæ­¢æ‰«æä»»åŠ¡
- **åº”ç”¨è¢«æ€æ­»** â†’ æ‰€æœ‰æ‰«æè‡ªåŠ¨ç»ˆæ­¢
- **è®¾å¤‡é‡å¯** â†’ æ‰«æè¿›ç¨‹è‡ªç„¶ç»“æŸ

### **4. ğŸš« CancellationSignal æœºåˆ¶**

æ¯ä¸ªæ‰«æä»»åŠ¡éƒ½æœ‰è‡ªå·±çš„å–æ¶ˆä¿¡å·ï¼š

```404:404:CarMediaCenter/MediaProvider/src/com/android/providers/media/scan/ModernMediaScanner.java
mSignal = new CancellationSignal();
```

å½“ `mSignal.cancel()` è¢«è°ƒç”¨æ—¶ï¼Œä¼šæŠ›å‡º `OperationCanceledException`ï¼š

```254:258:CarMediaCenter/MediaProvider/src/com/android/providers/media/scan/ModernMediaScanner.java
try (Scan scan = new Scan(file, reason, /*ownerPackage*/ null)) {
    scan.run();
} catch (OperationCanceledException ignored) {
} catch (FileNotFoundException e) {
   Log.e(TAG, "Couldn't find directory to scan", e) ;
}
```

## **æ€»ç»“**

**MediaProvider è®¾è®¡å“²å­¦**ï¼š
- **æ²¡æœ‰ä¸»åŠ¨åœæ­¢API** - æ‰«ææ˜¯ä¸ºäº†ä¿æŒæ•°æ®åº“ä¸€è‡´æ€§ï¼Œé€šå¸¸åº”è¯¥å®Œæˆ
- **è¢«åŠ¨åœæ­¢æœºåˆ¶** - åªåœ¨å¿…è¦æ—¶åœæ­¢ï¼ˆå·å¸è½½ã€ç³»ç»Ÿèµ„æºä¸è¶³ç­‰ï¼‰
- **è‡ªç„¶ç»ˆæ­¢** - æ‰«æå®Œæˆåè‡ªåŠ¨ç»“æŸ

å¦‚æœä½ éœ€è¦**å¼ºåˆ¶åœæ­¢ç‰¹å®šå·çš„æ‰«æ**ï¼Œå¯ä»¥è°ƒç”¨ï¼š
```java
mediaProvider.onDetachVolume(targetVolume);
```

è¿™æ˜¯æœ€æ¥è¿‘"åœæ­¢æ‰«æå‡½æ•°"çš„æ–¹æ³•ã€‚